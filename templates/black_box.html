{% extends "base.html" %}

{% block title %}∎ BLACK BOX - {{ difficulty.upper() }} MODE ∎{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
    <h1 class="matrix-text">∎ MATRIX CODE ANALYZER ∎</h1>
    <p style="color: var(--star-white); font-size: 1.1rem;">
        Discover hidden mathematical patterns in the cosmic matrix...
    </p>
</div>

<div class="status-display">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <div class="level-display">TESTS: <span id="tests-count">0</span></div>
        <div class="score-display">PATTERN: <span id="pattern-status">UNKNOWN</span></div>
        <div style="color: var(--magic-pink);">DIFFICULTY: {{ difficulty.upper() }}</div>
    </div>
</div>

<div style="background: linear-gradient(135deg, var(--space-dark), var(--universe-purple)); border: 2px solid var(--magic-violet); border-radius: 12px; padding: 25px; margin: 20px 0;">
    <h3 style="color: var(--magic-violet); margin-bottom: 20px; text-align: center;">∎ MATRIX PATTERN CHAMBER ∎</h3>
    
    <div id="black-box-display" style="background: rgba(0,0,0,0.9); border: 2px solid var(--terminal-green); border-radius: 8px; padding: 20px; margin: 20px 0; font-family: 'Courier New'; color: var(--terminal-green);">
        <div style="text-align: center; margin-bottom: 15px; color: var(--quantum-glow);">
            ∎ MATHEMATICAL BLACK BOX ∎
        </div>
        <div style="font-size: 1.1rem; line-height: 1.8;">
            INPUT → ? → OUTPUT
        </div>
        <div id="test-results" style="margin-top: 15px; max-height: 200px; overflow-y: auto;">
            <div style="color: var(--magic-cyan);">Ready for input testing...</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
        <div>
            <label style="color: var(--star-white); display: block; margin-bottom: 8px;">TEST INPUT:</label>
            <input type="number" 
                   id="test-input" 
                   class="cosmic-input" 
                   placeholder="Enter number..."
                   style="width: 100%;">
        </div>
        <div>
            <label style="color: var(--star-white); display: block; margin-bottom: 8px;">PATTERN GUESS:</label>
            <input type="text" 
                   id="pattern-guess" 
                   class="cosmic-input" 
                   placeholder="e.g., x*2+1"
                   style="width: 100%;">
        </div>
    </div>
    
    <div style="text-align: center; margin: 25px 0;">
        <button id="test-btn" class="cosmic-btn" style="margin: 0 10px;">
            <i class="fas fa-vial"></i> TEST_INPUT
        </button>
        
        <button id="guess-btn" class="cosmic-btn" style="margin: 0 10px;">
            <i class="fas fa-brain"></i> SUBMIT_PATTERN
        </button>
        
        <button id="hint-btn" class="cosmic-btn" style="background: linear-gradient(45deg, var(--magic-cyan), var(--nebula-blue)); margin: 0 10px;">
            <i class="fas fa-lightbulb"></i> MATRIX_HINT
        </button>
    </div>
</div>

<div style="text-align: center; margin: 30px 0;">
    <a href="/games" class="cosmic-btn" style="background: linear-gradient(45deg, var(--void-gray), var(--space-dark));">
        <i class="fas fa-arrow-left"></i> EXIT_MATRIX
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
class BlackBoxGame {
    constructor() {
        this.difficulty = '{{ difficulty }}';
        this.testsCount = 0;
        this.maxTests = this.difficulty === 'hard' ? 12 : this.difficulty === 'medium' ? 8 : 6;
        this.hintsUsed = 0;
        
        // Define patterns by difficulty
        this.patterns = {
            easy: [
                { func: x => x * 2, description: 'x * 2', hint: 'Try doubling the input' },
                { func: x => x + 5, description: 'x + 5', hint: 'Add a constant number' },
                { func: x => x * 3, description: 'x * 3', hint: 'Multiply by a single digit' },
            ],
            medium: [
                { func: x => x * 2 + 1, description: 'x * 2 + 1', hint: 'Multiply then add' },
                { func: x => x * x, description: 'x²', hint: 'Think about squaring' },
                { func: x => x * 3 - 2, description: 'x * 3 - 2', hint: 'Multiply then subtract' },
            ],
            hard: [
                { func: x => x * x + x, description: 'x² + x', hint: 'Square plus original' },
                { func: x => Math.floor(x / 2) * 3, description: '(x ÷ 2) * 3', hint: 'Divide then multiply' },
                { func: x => x * 2 + x * x, description: '2x + x²', hint: 'Linear plus quadratic' },
            ]
        };
        
        this.currentPattern = this.patterns[this.difficulty][Math.floor(Math.random() * this.patterns[this.difficulty].length)];
        this.testResults = [];
        
        this.init();
    }
    
    init() {
        document.getElementById('test-btn').addEventListener('click', () => this.testInput());
        document.getElementById('guess-btn').addEventListener('click', () => this.checkPattern());
        document.getElementById('hint-btn').addEventListener('click', () => this.showHint());
        
        document.getElementById('test-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.testInput();
        });
        
        document.getElementById('pattern-guess').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.checkPattern();
        });
    }
    
    testInput() {
        const input = parseInt(document.getElementById('test-input').value);
        
        if (isNaN(input)) {
            this.showFeedback("Please enter a valid number!", 'warning');
            return;
        }
        
        if (this.testsCount >= this.maxTests) {
            this.showFeedback("Maximum tests reached! Make your guess.", 'warning');
            return;
        }
        
        const output = this.currentPattern.func(input);
        this.testResults.push({ input, output });
        this.testsCount++;
        
        document.getElementById('tests-count').textContent = this.testsCount;
        this.updateResultsDisplay();
        document.getElementById('test-input').value = '';
        
        if (this.testsCount >= this.maxTests) {
            this.showFeedback("Test limit reached! Time to guess the pattern.", 'info');
        }
    }
    
    updateResultsDisplay() {
        const resultsContainer = document.getElementById('test-results');
        resultsContainer.innerHTML = '';
        
        this.testResults.forEach((result, index) => {
            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'margin: 5px 0; color: var(--star-white);';
            resultDiv.innerHTML = `Test ${index + 1}: <span style="color: var(--magic-cyan);">${result.input}</span> → <span style="color: var(--terminal-green);">${result.output}</span>`;
            resultsContainer.appendChild(resultDiv);
        });
        
        resultsContainer.scrollTop = resultsContainer.scrollHeight;
    }
    
    checkPattern() {
        const guess = document.getElementById('pattern-guess').value.trim().toLowerCase();
        
        if (!guess) {
            this.showFeedback("Please enter your pattern guess!", 'warning');
            return;
        }
        
        // Simple pattern matching (case-insensitive)
        const correctPattern = this.currentPattern.description.toLowerCase();
        const isCorrect = guess === correctPattern || this.isPatternMatch(guess, correctPattern);
        
        if (isCorrect) {
            const baseScore = 500;
            const testBonus = Math.max(0, (this.maxTests - this.testsCount) * 50);
            const hintPenalty = this.hintsUsed * 100;
            const finalScore = Math.max(100, baseScore + testBonus - hintPenalty);
            
            this.showFeedback(`🎯 PATTERN CRACKED! Score: ${finalScore}`, 'success');
            
            setTimeout(() => {
                showCosmicSuccess('Black Box', finalScore, 
                    `You discovered the pattern "${this.currentPattern.description}" in ${this.testsCount} tests!`);
            }, 2000);
            
        } else {
            this.showFeedback("❌ Pattern incorrect! Try again or get a hint.", 'error');
        }
    }
    
    isPatternMatch(guess, correct) {
        // Check for common variations
        const variations = {
            'x*2': ['x * 2', '2x', '2*x'],
            'x+5': ['x + 5', '5+x'],
            'x*3': ['x * 3', '3x', '3*x'],
            'x*2+1': ['x * 2 + 1', '2x+1', '2*x+1'],
            'x²': ['x^2', 'x*x', 'x squared'],
            'x*3-2': ['x * 3 - 2', '3x-2', '3*x-2']
        };
        
        return variations[correct] && variations[correct].includes(guess);
    }
    
    showHint() {
        if (this.hintsUsed >= 2) {
            this.showFeedback("No more hints available!", 'warning');
            return;
        }
        
        this.hintsUsed++;
        this.showFeedback(`💡 Hint: ${this.currentPattern.hint}`, 'info');
    }
    
    showFeedback(message, type) {
        const feedback = document.createElement('div');
        feedback.textContent = message;
        feedback.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: ${type === 'success' ? 'var(--terminal-green)' : type === 'error' ? 'var(--magic-pink)' : 'var(--magic-cyan)'};
            color: var(--cosmic-black); padding: 20px 30px; border-radius: 10px;
            font-weight: bold; z-index: 2000; font-size: 1.1rem;
            box-shadow: 0 0 40px ${type === 'success' ? 'var(--terminal-green)' : type === 'error' ? 'var(--magic-pink)' : 'var(--magic-cyan)'};
        `;
        
        document.body.appendChild(feedback);
        setTimeout(() => document.body.removeChild(feedback), 2500);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    new BlackBoxGame();
});
</script>
{% endblock %}
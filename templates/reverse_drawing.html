{% extends "base.html" %}

{% block title %}‚àé REVERSE DRAWING - {{ difficulty.upper() }} MODE ‚àé{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
    <h1 class="matrix-text">‚àé VOID DRAWING PROTOCOL ‚àé</h1>
    <p style="color: var(--star-white); font-size: 1.1rem;">
        Create cosmic art with inverted cursor controls in zero gravity...
    </p>
</div>

<div class="status-display">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <div class="level-display">SHAPE: <span id="target-shape">Circle</span></div>
        <div class="score-display">COMPLETED: <span id="completed-shapes">0</span> / <span id="total-shapes">3</span></div>
        <div style="color: var(--magic-pink);">DIFFICULTY: {{ difficulty.upper() }}</div>
    </div>
</div>

<div style="background: linear-gradient(135deg, var(--space-dark), var(--universe-purple)); border: 2px solid var(--code-orange); border-radius: 12px; padding: 25px; margin: 20px 0; text-align: center;">
    <h3 style="color: var(--code-orange); margin-bottom: 20px;">‚àé VOID CANVAS CHAMBER ‚àé</h3>
    <p style="color: var(--quantum-glow); margin-bottom: 20px;">Draw the target shape: <span id="current-target" style="font-size: 1.3rem; color: var(--terminal-green);">CIRCLE</span></p>
    
    <div style="position: relative; display: inline-block;">
        <canvas id="drawing-canvas" 
                width="400" 
                height="300" 
                style="border: 2px solid var(--terminal-green); background: rgba(0,0,0,0.8); border-radius: 8px; cursor: crosshair;">
        </canvas>
        <div id="cursor-indicator" style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); color: var(--magic-cyan); font-size: 0.9rem;">
            ‚ö†Ô∏è INVERTED CONTROLS ACTIVE ‚ö†Ô∏è
        </div>
    </div>
    
    <div style="margin: 20px 0;">
        <button id="clear-btn" class="cosmic-btn" style="background: linear-gradient(45deg, var(--magic-pink), var(--magic-violet));">
            <i class="fas fa-eraser"></i> CLEAR_CANVAS
        </button>
        
        <button id="submit-btn" class="cosmic-btn">
            <i class="fas fa-check"></i> SUBMIT_CREATION
        </button>
        
        <button id="skip-btn" class="cosmic-btn" style="background: linear-gradient(45deg, var(--magic-cyan), var(--nebula-blue));">
            <i class="fas fa-forward"></i> SKIP_SHAPE
        </button>
    </div>
</div>

<div style="text-align: center; margin: 30px 0;">
    <a href="/games" class="cosmic-btn" style="background: linear-gradient(45deg, var(--void-gray), var(--space-dark));">
        <i class="fas fa-arrow-left"></i> EXIT_CHAMBER
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
class ReverseDrawingGame {
    constructor() {
        this.difficulty = '{{ difficulty }}';
        this.completedShapes = 0;
        this.totalShapes = this.difficulty === 'hard' ? 5 : this.difficulty === 'medium' ? 4 : 3;
        this.currentShapeIndex = 0;
        this.shapes = ['CIRCLE', 'SQUARE', 'TRIANGLE', 'STAR', 'DIAMOND'];
        
        this.canvas = document.getElementById('drawing-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.isDrawing = false;
        this.lastX = 0;
        this.lastY = 0;
        
        this.setupCanvas();
        this.init();
    }
    
    init() {
        document.getElementById('total-shapes').textContent = this.totalShapes;
        document.getElementById('clear-btn').addEventListener('click', () => this.clearCanvas());
        document.getElementById('submit-btn').addEventListener('click', () => this.submitDrawing());
        document.getElementById('skip-btn').addEventListener('click', () => this.skipShape());
        this.nextShape();
    }
    
    setupCanvas() {
        // Set up inverted drawing controls
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());
        
        // Style the drawing
        this.ctx.strokeStyle = '#00ff41';
        this.ctx.lineWidth = 3;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.shadowBlur = 10;
        this.ctx.shadowColor = '#00ff41';
    }
    
    startDrawing(e) {
        this.isDrawing = true;
        const rect = this.canvas.getBoundingClientRect();
        // Invert the coordinates
        this.lastX = this.canvas.width - (e.clientX - rect.left);
        this.lastY = this.canvas.height - (e.clientY - rect.top);
    }
    
    draw(e) {
        if (!this.isDrawing) return;
        
        const rect = this.canvas.getBoundingClientRect();
        // Invert the coordinates
        const currentX = this.canvas.width - (e.clientX - rect.left);
        const currentY = this.canvas.height - (e.clientY - rect.top);
        
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastX, this.lastY);
        this.ctx.lineTo(currentX, currentY);
        this.ctx.stroke();
        
        this.lastX = currentX;
        this.lastY = currentY;
    }
    
    stopDrawing() {
        this.isDrawing = false;
    }
    
    nextShape() {
        if (this.currentShapeIndex >= this.totalShapes) {
            this.endGame();
            return;
        }
        
        const currentShape = this.shapes[this.currentShapeIndex];
        document.getElementById('target-shape').textContent = currentShape;
        document.getElementById('current-target').textContent = currentShape;
        this.clearCanvas();
    }
    
    clearCanvas() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
    
    submitDrawing() {
        // Simple validation - check if there's something drawn
        const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
        const hasDrawing = imageData.data.some((pixel, index) => {
            return index % 4 === 3 && pixel > 0; // Check alpha channel
        });
        
        if (!hasDrawing) {
            this.showFeedback("Please draw something first!", 'warning');
            return;
        }
        
        // Always approve the drawing (simplified for cosmic theme)
        this.completedShapes++;
        document.getElementById('completed-shapes').textContent = this.completedShapes;
        
        this.showFeedback("üé® COSMIC ART ACCEPTED! üé®", 'success');
        
        setTimeout(() => {
            this.currentShapeIndex++;
            this.nextShape();
        }, 2000);
    }
    
    skipShape() {
        if (confirm('Skip this void drawing challenge?')) {
            this.currentShapeIndex++;
            this.nextShape();
        }
    }
    
    showFeedback(message, type) {
        const feedback = document.createElement('div');
        feedback.textContent = message;
        feedback.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: ${type === 'success' ? 'var(--terminal-green)' : type === 'warning' ? 'var(--magic-cyan)' : 'var(--magic-pink)'};
            color: var(--cosmic-black); padding: 20px 30px; border-radius: 10px;
            font-weight: bold; z-index: 2000; font-size: 1.2rem;
            box-shadow: 0 0 40px ${type === 'success' ? 'var(--terminal-green)' : type === 'warning' ? 'var(--magic-cyan)' : 'var(--magic-pink)'};
        `;
        
        document.body.appendChild(feedback);
        setTimeout(() => document.body.removeChild(feedback), 2000);
    }
    
    endGame() {
        const finalScore = this.completedShapes * 150;
        showCosmicSuccess('Reverse Drawing', finalScore, 
            `You completed ${this.completedShapes} void art pieces! Creative mastery achieved!`);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    new ReverseDrawingGame();
});
</script>
{% endblock %}